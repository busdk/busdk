name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    env:
      SUBMODULES_TOKEN: ${{ secrets.BUSDK_SUBMODULES_TOKEN }}
      GIT_TERMINAL_PROMPT: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          token: ${{ secrets.BUSDK_SUBMODULES_TOKEN }}

      - name: Configure private submodule access
        run: |
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Init submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build all modules
        run: make build

      - name: Package artifacts
        run: |
          VERSION="${{ github.ref_name }}"
          OS="${{ runner.os }}"
          ARCH="$(uname -m)"
          ARTIFACT="busdk-${VERSION}-${OS}-${ARCH}.tar.gz"
          tar -czf "$ARTIFACT" -C bin .
          shasum -a 256 "$ARTIFACT" > "${ARTIFACT}.sha256"

      - name: Generate install script
        run: |
          cat > install.sh <<'EOF'
          #!/usr/bin/env sh
          set -eu
          
          REPO="busdk/busdk"
          MODE="install"
          VERSION=""
          
          usage() {
            cat >&2 <<'USAGE'
          usage:
            install.sh [--version <tag>]         Install or upgrade to a tag
            install.sh <tag>                     Install or upgrade to a tag
            install.sh --uninstall               Remove installed binaries
          
          notes:
            - Re-running the install overwrites existing binaries (upgrade).
            - Private releases require GITHUB_TOKEN with read access.
            - Override install path with PREFIX/BINDIR; use DESTDIR for packaging.
          USAGE
          }
          
          while [ $# -gt 0 ]; do
            case "$1" in
              --uninstall|uninstall)
                MODE="uninstall"
                ;;
              --version)
                shift
                VERSION="${1:-}"
                ;;
              -h|--help)
                usage
                exit 0
                ;;
              *)
                VERSION="$1"
                ;;
            esac
            shift
          done
          
          require_token() {
            if [ -z "${GITHUB_TOKEN:-}" ]; then
              echo "GITHUB_TOKEN is required to access private releases." >&2
              echo "Set it to a PAT with read access to ${REPO}." >&2
              exit 1
            fi
          }
          
          fetch_latest_version() {
            require_token
            curl -fsSL \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/releases/latest" \
              | sed -n 's/.*"tag_name":[[:space:]]*"\([^"]*\)".*/\1/p'
          }
          
          PREFIX="${PREFIX:-$HOME/.local}"
          BINDIR="${BINDIR:-$PREFIX/bin}"
          DESTDIR="${DESTDIR:-}"
          TARGET_DIR="${DESTDIR}${BINDIR}"
          
          if [ "$MODE" = "uninstall" ]; then
            rm -f "$TARGET_DIR/bus" "$TARGET_DIR"/bus-*
            echo "Removed BusDK binaries from $TARGET_DIR"
            exit 0
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="$(fetch_latest_version)"
            if [ -z "$VERSION" ]; then
              echo "unable to determine latest release tag" >&2
              exit 1
            fi
          fi
          
          OS="$(uname -s)"
          ARCH="$(uname -m)"
          
          case "$OS" in
            Linux) OS="Linux" ;;
            Darwin) OS="macOS" ;;
            *) echo "unsupported OS: $OS" >&2; exit 1 ;;
          esac
          
          ARTIFACT="busdk-${VERSION}-${OS}-${ARCH}.tar.gz"
          URL="https://github.com/${REPO}/releases/download/${VERSION}/${ARTIFACT}"
          
          TMP_DIR="$(mktemp -d)"
          trap 'rm -rf "$TMP_DIR"' EXIT
          
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -o "$TMP_DIR/$ARTIFACT" "$URL"
          else
            curl -fsSL -o "$TMP_DIR/$ARTIFACT" "$URL"
          fi
          
          tar -xzf "$TMP_DIR/$ARTIFACT" -C "$TMP_DIR"
          
          mkdir -p "$TARGET_DIR"
          
          for bin in "$TMP_DIR"/bus*; do
            if [ -f "$bin" ]; then
              install -m 0755 "$bin" "$TARGET_DIR/"
            fi
          done
          
          echo "Installed BusDK binaries to $TARGET_DIR"
          EOF
          chmod +x install.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.os }}
          path: |
            busdk-*.tar.gz
            busdk-*.tar.gz.sha256
            install.sh

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md <<'EOF'
          # BusDK Release

          This release contains prebuilt BusDK binaries only (no source archives).

          ## Install (private releases)

          The install script requires a `GITHUB_TOKEN` (PAT with read access).

          ```sh
          curl -fsS https://github.com/busdk/busdk/releases/latest/download/install.sh | GITHUB_TOKEN=... sh
          ```

          Install a specific tag:

          ```sh
          curl -fsS https://github.com/busdk/busdk/releases/latest/download/install.sh | GITHUB_TOKEN=... sh -s -- v0.1.0
          ```

          Uninstall:

          ```sh
          curl -fsS https://github.com/busdk/busdk/releases/latest/download/install.sh | GITHUB_TOKEN=... sh -s -- --uninstall
          ```

          Override install path:

          ```sh
          PREFIX=/opt/busdk BINDIR=/opt/busdk/bin \
            curl -fsS https://github.com/busdk/busdk/releases/latest/download/install.sh | GITHUB_TOKEN=... sh
          ```

          Packaging with `DESTDIR`:

          ```sh
          DESTDIR=/tmp/pkg PREFIX=/usr \
            curl -fsS https://github.com/busdk/busdk/releases/latest/download/install.sh | GITHUB_TOKEN=... sh
          ```

          ## Licensing note

          Pre-built BusDK CLI tools are freeware and free to use. Full source code
          access and use is available for commercial users under the MIT license
          with a paid contract and subscription model. For source licensing,
          contact info@hg.fi.

          ## Documentation

          Documentation and specifications: https://docs.busdk.com
          EOF

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            dist/*.tar.gz
            dist/*.sha256
            dist/install.sh
            RELEASE_NOTES.md
          fail_on_unmatched_files: true
