name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    env:
      SUBMODULES_TOKEN: ${{ secrets.BUSDK_SUBMODULES_TOKEN }}
      GIT_TERMINAL_PROMPT: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          token: ${{ secrets.BUSDK_SUBMODULES_TOKEN }}

      - name: Validate submodule token
        run: |
          if [ -z "${SUBMODULES_TOKEN:-}" ]; then
            echo "BUSDK_SUBMODULES_TOKEN is missing or empty." >&2
            echo "Create the secret and ensure it has access to all private submodules." >&2
            exit 1
          fi

      - name: Normalize submodule URLs to HTTPS
        run: |
          python - <<'PY'
          from pathlib import Path
          path = Path(".gitmodules")
          if not path.exists():
            raise SystemExit("missing .gitmodules")
          data = path.read_text()
          data = data.replace("git@github.com:", "https://github.com/")
          data = data.replace("ssh://git@github.com/", "https://github.com/")
          path.write_text(data)
          PY

      - name: Configure private submodule access
        run: |
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${SUBMODULES_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Init submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run module tests
        run: make test

      - name: Build all modules
        run: make build

      - name: Package artifacts
        run: |
          VERSION="${{ github.ref_name }}"
          OS="${{ runner.os }}"
          ARCH="$(uname -m)"
          ARTIFACT="busdk-${VERSION}-${OS}-${ARCH}.tar.gz"
          tar -czf "$ARTIFACT" -C bin .
          shasum -a 256 "$ARTIFACT" > "${ARTIFACT}.sha256"

      - name: Generate install script
        run: |
          cat > install.sh <<'EOF'
          #!/usr/bin/env sh
          set -eu
          
          REPO="busdk/busdk"
          MODE="install"
          VERSION=""
          
          usage() {
            cat >&2 <<'USAGE'
          usage:
            install.sh [--version <tag>]         Install or upgrade to a tag
            install.sh <tag>                     Install or upgrade to a tag
            install.sh --uninstall               Remove installed binaries
          
          notes:
            - Re-running the install overwrites existing binaries (upgrade).
            - Releases are public; GITHUB_TOKEN is only needed for private assets.
            - Override install path with PREFIX/BINDIR; use DESTDIR for packaging.
          USAGE
          }
          
          while [ $# -gt 0 ]; do
            case "$1" in
              --uninstall|uninstall)
                MODE="uninstall"
                ;;
              --version)
                shift
                VERSION="${1:-}"
                ;;
              -h|--help)
                usage
                exit 0
                ;;
              *)
                VERSION="$1"
                ;;
            esac
            shift
          done
          
          fetch_latest_version() {
            if [ -n "${GITHUB_TOKEN:-}" ]; then
              curl -fsSL \
                -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${REPO}/releases/latest" \
                | sed -n 's/.*"tag_name":[[:space:]]*"\([^"]*\)".*/\1/p'
              return
            fi
            curl -fsSL \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/releases/latest" \
              | sed -n 's/.*"tag_name":[[:space:]]*"\([^"]*\)".*/\1/p'
          }
          
          PREFIX="${PREFIX:-$HOME/.local}"
          BINDIR="${BINDIR:-$PREFIX/bin}"
          DESTDIR="${DESTDIR:-}"
          TARGET_DIR="${DESTDIR}${BINDIR}"
          
          if [ "$MODE" = "uninstall" ]; then
            rm -f "$TARGET_DIR/bus" "$TARGET_DIR"/bus-*
            echo "Removed BusDK binaries from $TARGET_DIR"
            exit 0
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="$(fetch_latest_version)"
            if [ -z "$VERSION" ]; then
              echo "unable to determine latest release tag" >&2
              exit 1
            fi
          fi
          
          OS="$(uname -s)"
          ARCH="$(uname -m)"
          
          case "$OS" in
            Linux) OS="Linux" ;;
            Darwin) OS="macOS" ;;
            *) echo "unsupported OS: $OS" >&2; exit 1 ;;
          esac
          
          ARTIFACT="busdk-${VERSION}-${OS}-${ARCH}.tar.gz"
          URL="https://github.com/${REPO}/releases/download/${VERSION}/${ARTIFACT}"
          
          TMP_DIR="$(mktemp -d)"
          trap 'rm -rf "$TMP_DIR"' EXIT
          
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -o "$TMP_DIR/$ARTIFACT" "$URL"
          else
            curl -fsSL -o "$TMP_DIR/$ARTIFACT" "$URL"
          fi
          
          tar -xzf "$TMP_DIR/$ARTIFACT" -C "$TMP_DIR"
          
          mkdir -p "$TARGET_DIR"
          
          for bin in "$TMP_DIR"/bus*; do
            if [ -f "$bin" ]; then
              install -m 0755 "$bin" "$TARGET_DIR/"
            fi
          done
          
          echo "Installed BusDK binaries to $TARGET_DIR"
          EOF
          chmod +x install.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.os }}
          path: |
            busdk-*.tar.gz
            busdk-*.tar.gz.sha256
            install.sh

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate release notes
        run: |
          VERSION="${{ github.ref_name }}"
          cat > RELEASE_NOTES.md <<EOF
          ## BusDK ${VERSION} — Release notes

          This release ships the official BusDK CLI binaries for the \`bus\` dispatcher and included modules.

          Docs: https://docs.busdk.com

          ### Install (this release)

          Quick install using the release script:

          \`\`\`sh
          curl -fsSL https://github.com/busdk/busdk/releases/download/${VERSION}/install.sh | sh
          \`\`\`

          Uninstall:

          \`\`\`sh
          curl -fsSL https://github.com/busdk/busdk/releases/download/${VERSION}/install.sh | sh -s -- --uninstall
          \`\`\`

          Manual install:

          \`\`\`sh
          tar -xzf busdk-${VERSION}-<os>-<arch>.tar.gz
          install -m 0755 bus* /usr/local/bin/
          \`\`\`

          Verify the install:

          \`\`\`sh
          bus --help
          bus-journal --help
          \`\`\`

          Verify downloads:

          \`\`\`sh
          shasum -a 256 busdk-${VERSION}-<os>-<arch>.tar.gz
          cat busdk-${VERSION}-<os>-<arch>.tar.gz.sha256
          \`\`\`

          ### Availability and business model

          BusDK binaries are published free of charge so anyone can download and run the tools. The full source code and documentation are available to subscribers while their subscription is active. Subscriber-accessible code and docs are provided under the MIT License, so once you have access you may use, modify, and redistribute them under MIT terms. Subscriptions fund ongoing development, maintenance, and timely updates, and are the simplest official way to stay current.

          ### Source code licensing (subscribers)

          All source code and documentation provided to subscribers is licensed under the MIT License (see the \`LICENSE\` file in the source repository). MIT allows redistribution, including public redistribution, and does not require an ongoing subscription to keep using what you already received.

          ### Binary release license (free to use)

          The downloadable binaries in this GitHub Release are provided under the following terms (“BusDK Binary Release Terms”):

          1. Grant of rights: You may download, run, and use these binaries free of charge for any purpose, including commercial use. You may also copy and redistribute the unmodified binaries and this release text, provided you keep this “Binary release license” section intact.

          2. No source code grant: These binaries do not include source code. Source code and documentation access is provided separately to subscribers under the MIT License.

          3. Trademarks: This license does not grant any right to use BusDK trademarks, logos, or branding in a way that suggests endorsement or official status for modified or third-party distributions.

          4. No warranty: THE BINARIES ARE PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

          5. Limitation of liability: IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE BINARIES OR THE USE OR OTHER DEALINGS IN THE BINARIES.

          If you need the corresponding source code and full documentation, obtain access via an active subscription (details: info@hg.fi).
          EOF

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            dist/*.tar.gz
            dist/*.sha256
            dist/install.sh
            RELEASE_NOTES.md
          fail_on_unmatched_files: true
